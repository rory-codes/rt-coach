{% extends 'base.html' %}
{% load static %}

{# Override the hero from base.html #}
{% block hero %}
<section class="container-fluid px-0">
  <div class="masthead">
    <div class="masthead-image">
      <img class="masthead-photo" src="{% static 'img/data.jpg' %}" alt="">
    </div>
    <div class="masthead-text">
      <h1 class="post-title">Fitness Data</h1>
      <p class="post-subtitle">
        Input your data to find out more about heart rate zones, waist-hip ratio and BMI
      </p>
    </div>
  </div>
</section>
{% endblock hero %}

{% block content %}
    <!-- Personal Metrics -->
    <div class="row mt-2">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="card-title mb-3">Personal Metrics</h4>
                    <form onsubmit="return false;" novalidate>
                        <div class="row g-3">
                            <div class="col-sm-6 col-md-3">
                                <label for="weightKg" class="form-label">Weight (kg)</label>
                                <input type="number" step="0.1" min="0" max="500" class="form-control" id="weightKg"
                                    placeholder="72.5" aria-describedby="bmiHelp">
                                <div id="bmiHelp" class="form-text">Used with height to compute BMI.</div>
                            </div>
                            <div class="col-sm-6 col-md-3">
                                <label for="heightCm" class="form-label">Height (cm)</label>
                                <input type="number" step="0.1" min="30" max="300" class="form-control" id="heightCm"
                                    placeholder="175">
                            </div>

                            <div class="col-sm-6 col-md-3">
                                <label for="waistCm" class="form-label">Waist (cm)</label>
                                <input type="number" step="0.1" min="20" max="300" class="form-control" id="waistCm"
                                    placeholder="82" aria-describedby="whrHelp">
                                <div id="whrHelp" class="form-text">Waist ÷ Hip gives WHR.</div>
                            </div>
                            <div class="col-sm-6 col-md-3">
                                <label for="hipCm" class="form-label">Hip (cm)</label>
                                <input type="number" step="0.1" min="20" max="300" class="form-control" id="hipCm"
                                    placeholder="96">
                            </div>

                            <div class="col-sm-6 col-md-3">
                                <label for="age" class="form-label">Age (years)</label>
                                <input type="number" min="1" max="120" class="form-control" id="age" placeholder="34"
                                    aria-describedby="hrHelp">
                            </div>
                            <div class="col-sm-6 col-md-3">
                                <label for="rhr" class="form-label">Resting Heart Rate (bpm)</label>
                                <input type="number" min="20" max="150" class="form-control" id="rhr" placeholder="60">
                                <div id="hrHelp" class="form-text">Zones use Karvonen (HRR) method.</div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-primary" id="calcBtn">Calculate</button>
                            <button type="button" class="btn btn-outline-secondary ms-2" id="clearBtn">Clear</button>
                        </div>
                    </form>

                    <hr class="my-4">

                    <div class="row g-4">
                        <div class="col-md-4">
                            <h6 class="text-uppercase text-muted mb-2">BMI</h6>
                            <p class="mb-1 fs-5"><strong id="bmiValue" aria-live="polite">—</strong></p>
                            <small id="bmiNote" class="text-muted" aria-live="polite"></small>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-uppercase text-muted mb-2">Waist-to-Hip Ratio</h6>
                            <p class="mb-1 fs-5"><strong id="whrValue" aria-live="polite">—</strong></p>
                            <small id="whrNote" class="text-muted">Waist ÷ Hip</small>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-uppercase text-muted mb-2">Max HR & HR Reserve</h6>
                            <p class="mb-1">Max HR: <strong id="maxHr" aria-live="polite">—</strong> bpm</p>
                            <p class="mb-1">HRR: <strong id="hrr" aria-live="polite">—</strong> bpm</p>
                            <small class="text-muted">Max HR = 220 − age; HRR = Max HR − Resting HR.</small>
                        </div>
                    </div>

                    <div class="table-responsive mt-4">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Zone</th>
                                    <th>Intensity (% HRR)</th>
                                    <th class="text-end">Target Range (bpm)</th>
                                </tr>
                            </thead>
                            <tbody id="zonesBody" aria-live="polite">
                                <tr>
                                    <td colspan="3" class="text-muted">Enter age and resting heart rate to see zones.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /Personal Metrics -->

    <div class="row">
        <div class="col text-right">
            <p class="text-end"><em>Updated on: {{ fitness_data.updated_on }}</em></p>
        </div>
    </div>
</div>

<script>
    (function () {
        const $ = (id) => document.getElementById(id);

        const ZONES = [
            { name: "Zone 1", low: 0.50, high: 0.60 },
            { name: "Zone 2", low: 0.60, high: 0.70 },
            { name: "Zone 3", low: 0.70, high: 0.80 },
            { name: "Zone 4", low: 0.80, high: 0.90 },
            { name: "Zone 5", low: 0.90, high: 1.00 }
        ];

        function toNum(v) {
            const n = parseFloat(v);
            return Number.isFinite(n) ? n : null;
        }

        function clamp(n, min, max) {
            if (!Number.isFinite(n)) return null;
            return Math.min(Math.max(n, min), max);
        }

        function calcBMI(weightKg, heightCm) {
            weightKg = clamp(weightKg, 0, 500);
            heightCm = clamp(heightCm, 30, 300);
            if (!Number.isFinite(weightKg) || !Number.isFinite(heightCm)) return null;
            const hM = heightCm / 100;
            if (hM <= 0) return null;
            return weightKg / (hM * hM);
        }

        function bmiCategory(bmi) {
            if (bmi == null) return "";
            if (bmi < 18.5) return "Underweight";
            if (bmi < 25) return "Normal";
            if (bmi < 30) return "Overweight";
            return "Obese";
        }

        function calcWHR(waistCm, hipCm) {
            waistCm = clamp(waistCm, 20, 300);
            hipCm = clamp(hipCm, 20, 300);
            if (!Number.isFinite(waistCm) || !Number.isFinite(hipCm) || hipCm <= 0) return null;
            return waistCm / hipCm;
        }

        function calcMaxHR(age) {
            age = clamp(age, 1, 120);
            if (!Number.isFinite(age)) return null;
            return 220 - age;
        }

        function calcZones(age, rhr) {
            age = clamp(age, 1, 120);
            rhr = clamp(rhr, 20, 150);
            const max = calcMaxHR(age);
            if (!Number.isFinite(max) || !Number.isFinite(rhr) || rhr >= max) {
                return { max: max ?? null, hrr: null, zones: [] };
            }
            const hrr = max - rhr;
            const zones = ZONES.map(z => {
                const low = Math.round(rhr + hrr * z.low);
                const high = Math.round(rhr + hrr * z.high);
                return { ...z, lowBpm: low, highBpm: high };
            });
            return { max, hrr, zones };
        }

        function renderBMI() {
            const weight = toNum($("weightKg").value);
            const height = toNum($("heightCm").value);
            const bmi = calcBMI(weight, height);
            $("bmiValue").textContent = bmi ? bmi.toFixed(1) : "—";
            $("bmiNote").textContent = bmi ? `(${bmiCategory(bmi)})` : "";
        }

        function renderWHR() {
            const waist = toNum($("waistCm").value);
            const hip = toNum($("hipCm").value);
            const whr = calcWHR(waist, hip);
            $("whrValue").textContent = whr ? whr.toFixed(2) : "—";
        }

        function renderHRZones() {
            const age = toNum($("age").value);
            const rhr = toNum($("rhr").value);
            const { max, hrr, zones } = calcZones(age, rhr);

            $("maxHr").textContent = Number.isFinite(max) ? Math.round(max) : "—";
            $("hrr").textContent = Number.isFinite(hrr) ? Math.round(hrr) : "—";

            const tbody = $("zonesBody");
            tbody.innerHTML = "";
            if (!zones.length) {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td colspan="3" class="text-muted">Enter valid age and resting heart rate (RHR &lt; Max HR) to see zones.</td>`;
                tbody.appendChild(tr);
                return;
            }
            zones.forEach(z => {
                const tr = document.createElement("tr");
                const pct = `${Math.round(z.low * 100)}–${Math.round(z.high * 100)}%`;
                tr.innerHTML = `<td>${z.name}</td><td>${pct}</td><td class="text-end">${z.lowBpm}–${z.highBpm} bpm</td>`;
                tbody.appendChild(tr);
            });
        }

        function renderAll() {
            renderBMI();
            renderWHR();
            renderHRZones();
        }

        $("calcBtn").addEventListener("click", renderAll);
        ["weightKg", "heightCm", "waistCm", "hipCm", "age", "rhr"].forEach(id => $(id).addEventListener("input", renderAll));

        $("clearBtn").addEventListener("click", () => {
            ["weightKg", "heightCm", "waistCm", "hipCm", "age", "rhr"].forEach(id => $(id).value = "");
            renderAll();
        });

        renderAll();
    })();
</script>
{% endblock content %}